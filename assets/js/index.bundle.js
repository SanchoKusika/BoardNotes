!function(){"use strict";function e(){const e=document.querySelectorAll(".auth__tab"),t=document.querySelectorAll(".auth__form"),n=document.getElementById("loginForm"),a=document.getElementById("registerForm");function o(e,t,n=""){if(e.innerHTML="",n){const t=document.createElement("div");return t.classList.add("auth__notification","auth__notification--success"),t.textContent=n,void e.append(t)}for(let n in t){const a=document.createElement("div");a.classList.add("auth__notification","auth__notification--error"),a.textContent=t[n],e.append(a)}}e.forEach((n=>{n.addEventListener("click",(()=>{const a=n.dataset.tab;e.forEach((e=>e.classList.toggle("active",e===n))),t.forEach((e=>{e.classList.contains(`auth__form--${a}`)?(e.classList.add("active"),e.style.opacity="1",e.style.transform="translateY(0)"):(e.classList.remove("active"),e.style.opacity="",e.style.transform="")}))}))})),n&&n.addEventListener("submit",(async e=>{e.preventDefault();const t=n.querySelector(".auth__notifications"),a=new FormData(n),s=await fetch("functions/login.php",{method:"POST",body:a}),r=await s.json();r.success?(o(t,{},"Успешный вход! Перенаправление…"),setTimeout((()=>window.location.href="index.php"),800)):o(t,r.errors)})),a&&a.addEventListener("submit",(async e=>{e.preventDefault();const t=a.querySelector(".auth__notifications"),n=new FormData(a),s=await fetch("functions/register.php",{method:"POST",body:n}),r=await s.json();r.success?(o(t,{},"Регистрация прошла успешно! Перенаправление…"),setTimeout((()=>window.location.reload(!0)),1200)):o(t,r.errors)}))}"undefined"!=typeof document&&document.addEventListener("DOMContentLoaded",e);class t{constructor(){this.createSessionBtn=document.querySelector(".board__create-session-btn"),this.createSessionModal=document.getElementById("createSessionModal"),this.searchInput=this.createSessionModal?.querySelector(".modal__search .modal__input"),this.searchBtn=this.createSessionModal?.querySelector(".modal__search-btn"),this.usersList=this.createSessionModal?.querySelector(".modal__users-list"),this.selectedList=this.createSessionModal?.querySelector(".modal__selected-list"),this.sessionNameInput=this.createSessionModal?.querySelector("#sessionName"),this.createBtn=this.createSessionModal?.querySelector(".modal__create-btn"),this.closeBtn=this.createSessionModal?.querySelector(".modal__close-btn"),this.cancelBtn=this.createSessionModal?.querySelector(".modal__cancel-btn"),this.selectedUsers=new Set,this.init()}init(){this.createSessionBtn?.addEventListener("click",(()=>this.openModal())),this.closeBtn?.addEventListener("click",(()=>this.closeModal())),this.cancelBtn?.addEventListener("click",(()=>this.closeModal())),this.searchInput?.addEventListener("input",this.debounce((()=>this.searchUsers()),300)),this.searchBtn?.addEventListener("click",(()=>this.searchUsers())),this.createBtn?.addEventListener("click",(()=>this.createSession())),document.addEventListener("click",(e=>{e.target===this.createSessionModal&&this.closeModal()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.createSessionModal?.classList.contains("active")&&this.closeModal()}))}openModal(){this.createSessionModal?.classList.add("active"),document.body.style.overflow="hidden",this.searchUsers()}closeModal(){this.createSessionModal?.classList.remove("active"),document.body.style.overflow="",this.selectedUsers.clear(),this.updateSelectedList(),this.searchInput.value="",this.sessionNameInput.value=""}async searchUsers(){const e=this.searchInput?.value.trim()||"";try{const t=await fetch(`functions/search_users.php?search=${encodeURIComponent(e)}`),n=await t.json();n.success?this.renderUsersList(n.users):console.error("Ошибка при поиске пользователей:",n.errors)}catch(e){console.error("Ошибка при поиске пользователей:",e)}}renderUsersList(e){if(this.usersList){if(this.usersList.innerHTML="",0===e.length){const e=document.createElement("div");return e.className="modal__empty-state",e.textContent="Пользователи не найдены",void this.usersList.appendChild(e)}e.forEach((e=>{const t=document.createElement("div");t.className="modal__user-item",t.setAttribute("data-user-id",e.id),this.selectedUsers.has(e.id)&&t.classList.add("selected");const n=document.createElement("div");if(n.className="modal__user-avatar",e.avatar){const t=document.createElement("img");t.src=e.avatar,t.alt=e.name,n.appendChild(t)}else n.textContent=e.name.charAt(0).toUpperCase();const a=document.createElement("div");a.className="modal__user-info";const o=document.createElement("div");o.className="modal__user-name",o.textContent=e.name;const s=document.createElement("div");s.className="modal__user-email",s.textContent=e.email,a.appendChild(o),a.appendChild(s),t.appendChild(n),t.appendChild(a),t.addEventListener("click",(()=>{this.selectedUsers.has(e.id)?(this.selectedUsers.delete(e.id),t.classList.remove("selected")):(this.selectedUsers.add(e.id),t.classList.add("selected")),this.updateSelectedList()})),this.usersList.appendChild(t)}))}}updateSelectedList(){if(!this.selectedList)return;if(this.selectedList.innerHTML="",0===this.selectedUsers.size){const e=document.createElement("div");return e.className="modal__empty-state",e.textContent="Нет выбранных участников",void this.selectedList.appendChild(e)}Array.from(this.selectedUsers).map((e=>{const t=this.usersList.querySelector(`[data-user-id="${e}"]`);if(t){return{id:e,name:t.querySelector(".modal__user-name").textContent,avatar:t.querySelector(".modal__user-avatar").innerHTML}}return null})).filter(Boolean).forEach((e=>{const t=document.createElement("div");t.className="modal__selected-user";const n=document.createElement("div");n.className="modal__user-avatar",n.innerHTML=e.avatar;const a=document.createElement("span");a.className="modal__user-name",a.textContent=e.name;const o=document.createElement("button");o.className="modal__remove-user-btn",o.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 18L18 6M6 6l12 12"/></svg>',o.addEventListener("click",(t=>{t.stopPropagation(),this.selectedUsers.delete(e.id),this.updateSelectedList();const n=this.usersList.querySelector(`[data-user-id="${e.id}"]`);n&&n.classList.remove("selected")})),t.appendChild(n),t.appendChild(a),t.appendChild(o),this.selectedList.appendChild(t)}))}async createSession(){const e=this.sessionNameInput?.value.trim();if(e)if(0!==this.selectedUsers.size)try{const t=await fetch("functions/create_session.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,users:Array.from(this.selectedUsers)})}),n=await t.json();n.success?(alert("Сессия успешно создана"),window.location.href=`session.php?id=${n.session_id}`):(console.error("Ошибка при создании сессии:",n.errors),alert(n.errors.join("\n")))}catch(e){console.error("Ошибка при создании сессии:",e),alert("Ошибка при создании сессии")}else alert("Выберите хотя бы одного участника");else alert("Введите название сессии")}debounce(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout((()=>{clearTimeout(n),e(...a)}),t)}}}async function n(e){if(!e){const t=document.querySelector(".board");e=t?t.dataset.boardId:null}try{const t=await fetch(`functions/get_files.php?board_id=${e}`),n=await t.json();if(n.success){const e=document.querySelector(".swiper-wrapper");if(!e)return;if(e.innerHTML="",0===n.files.length){const t=document.createElement("div");return t.className="swiper-empty-state",t.textContent="Загрузите файлы для их отображения (вес файла не должен превышать 10 МБ)",void e.appendChild(t)}n.files.forEach((t=>{const a=document.createElement("div");a.className="swiper-slide files__slide";const o=document.createElement("div");o.className="files__item",o.style.cursor="pointer",o.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation();const n=document.querySelector(".file-context-menu");n&&n.remove();const o=document.createElement("div");o.className="context-menu file-context-menu",o.innerHTML='\n\t\t\t\t\t\t\t<div class="context-menu__item" data-action="delete">Удалить</div>\n\t\t\t\t\t\t',document.body.appendChild(o),o.style.top=`${e.clientY}px`,o.style.left=`${e.clientX}px`,o.style.display="block",o.addEventListener("click",(async e=>{if("delete"===e.target.dataset.action)try{const e=await fetch("functions/delete_file.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file_id:t.id})}),n=await e.json();if(n.success){a.remove();const e=document.querySelector(".swiper-wrapper"),t=e.querySelector(".swiper-empty-state");t&&(t.style.display=0===e.querySelectorAll(".swiper-slide").length?"flex":"none")}else console.error("Ошибка при удалении файла:",n.errors),alert(n.errors.join("\n"))}catch(e){console.error("Ошибка при удалении файла:",e),alert("Ошибка при удалении файла")}o.remove()}));const s=e=>{o.contains(e.target)||(o.remove(),document.removeEventListener("click",s))};document.addEventListener("click",s)})),o.addEventListener("click",(()=>{const e=document.createElement("a");let n=t.path;n.startsWith("/")||(n="/"+n),e.href=n,e.download=t.name,document.body.appendChild(e),e.click(),document.body.removeChild(e)}));const s=document.createElement("div");if(s.className="files__preview",t.type.startsWith("image/")){const e=document.createElement("img");e.src=t.path,e.alt=t.name,s.appendChild(e)}else s.innerHTML=function(e){return{"application/pdf":'<svg viewBox="0 0 24 24" fill="none" stroke="#ff4444"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/><path d="M9 9h1"/></svg>',"application/msword":'<svg viewBox="0 0 24 24" fill="none" stroke="#4444ff"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/><path d="M9 9h1"/></svg>',"application/vnd.openxmlformats-officedocument.wordprocessingml.document":'<svg viewBox="0 0 24 24" fill="none" stroke="#4444ff"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/><path d="M9 9h1"/></svg>',"application/vnd.ms-excel":'<svg viewBox="0 0 24 24" fill="none" stroke="#44ff44"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/><path d="M9 9h1"/></svg>',"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":'<svg viewBox="0 0 24 24" fill="none" stroke="#44ff44"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/><path d="M9 9h1"/></svg>',"application/zip":'<svg viewBox="0 0 24 24" fill="none" stroke="#ff8800"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/><path d="M9 9h1"/></svg>',"application/x-rar-compressed":'<svg viewBox="0 0 24 24" fill="none" stroke="#ff8800"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/><path d="M9 9h1"/></svg>',"application/x-7z-compressed":'<svg viewBox="0 0 24 24" fill="none" stroke="#ff8800"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/><path d="M9 9h1"/></svg>'}[e]||'<svg viewBox="0 0 24 24" fill="none" stroke="#666666"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 13h6"/><path d="M9 17h6"/><path d="M9 9h1"/></svg>'}(t.type);const r=document.createElement("div");r.className="files__info";const d=document.createElement("span");d.className="files__name",d.textContent=t.name,d.title=t.name;const c=document.createElement("span");c.className="files__size",c.textContent=function(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["Bytes","KB","MB","GB"][t]}(t.size);const i=document.createElement("div");i.className="files__meta",i.textContent=`Загружен: ${new Date(t.uploaded_at).toLocaleDateString()}`,n.is_session&&t.uploader&&(i.textContent+=` от ${t.uploader}`),r.appendChild(d),r.appendChild(c),r.appendChild(i),o.appendChild(s),o.appendChild(r),a.appendChild(o),e.appendChild(a)})),window.filesSwiper&&(window.filesSwiper.update(),window.filesSwiper.slideTo(0))}}catch(e){console.error("Ошибка при загрузке файлов:",e)}}async function a(e){const t=new FormData;t.append("file",e);const a=document.querySelector(".board"),o=a?a.dataset.boardId:null;if(!o)return console.error("ID доски не найден на элементе с классом .board"),alert("Ошибка: Не удалось определить ID доски для загрузки файла."),!1;t.append("board_id",o);try{const e=await fetch("functions/upload_file.php",{method:"POST",body:t}),a=await e.json();return a.success?(await n(o),!0):(console.error("Ошибка при загрузке файла:",a.errors),alert(a.errors.join("\n")),!1)}catch(e){return console.error("Ошибка при загрузке файла:",e),alert("Ошибка при загрузке файла"),!1}}async function o(e){try{const t=await fetch(`functions/get_notes.php?board_id=${e}`),n=await t.json();n.success?function(e){const t=document.querySelector(".board__column--todo .board__notes"),n=document.querySelector(".board__column--doing .board__notes"),a=document.querySelector(".board__column--done .board__notes");t&&(t.innerHTML="");n&&(n.innerHTML="");a&&(a.innerHTML="");const s=document.querySelector(".board");s&&s.dataset.boardId&&s.hasAttribute("data-board-id")&&window.location.pathname.includes("session.php");e.forEach((e=>{const o=function(e){const t=document.createElement("div");let n="";"todo"===e.note_column?n="board__note--yellow":"doing"===e.note_column?n="board__note--blue":"done"===e.note_column&&(n="board__note--green");t.className=`board__note ${n}`,t.setAttribute("draggable","true"),t.dataset.noteId=e.id,t.dataset.noteStatus=e.note_column;const a=document.createElement("div");return a.className="board__note-content",a.textContent=e.content,t.appendChild(a),t}(e);o&&("todo"===e.note_column&&t?t.appendChild(o):"doing"===e.note_column&&n?n.appendChild(o):"done"===e.note_column&&a&&a.appendChild(o))})),function(){const e=document.querySelectorAll(".board__note");e.forEach((e=>{e.dataset.contextMenuInitialized||e.addEventListener("contextmenu",(function(t){t.preventDefault(),t.stopPropagation();const n=document.querySelector(".context-menu");n&&n.remove();const a=document.createElement("div");a.className="context-menu note-context-menu",a.innerHTML='\n\t\t\t\t\t\t<div class="context-menu__item" data-action="edit">Редактировать</div>\n\t\t\t\t\t\t<div class="context-menu__item" data-action="delete">Удалить</div>\n\t\t\t\t\t',document.body.appendChild(a),a.style.top=`${t.clientY}px`,a.style.left=`${t.clientX}px`,a.style.display="block",a.addEventListener("click",(async e=>{const t=e.target.dataset.action,n=this.dataset.noteId;"edit"===t?function(e,t){const n=document.getElementById("createNoteModal"),a=n?.querySelector(".modal__textarea"),o=n?.querySelector(".modal__title"),s=n?.querySelector(".modal__create-btn");n&&a&&o&&s&&(o.textContent="Редактировать задачу",s.textContent="Сохранить",a.value=t,n.classList.add("active"),a.focus(),s.dataset.mode="edit",s.dataset.noteId=e)}(n,this.querySelector(".board__note-content").textContent):"delete"===t&&async function(e,t){try{const n=await fetch("functions/delete_note.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({note_id:e})}),a=await n.json();a.success?t.remove():(console.error("Ошибка при удалении заметки на сервере:",a.errors),alert("Ошибка при удалении заметки: "+(a.message||(a.errors?a.errors.join("\n"):"Неизвестная ошибка"))))}catch(e){console.error("Ошибка при отправке запроса на удаление заметки:",e),alert("Ошибка соединения при удалении заметки."+(e.message?": "+e.message:""))}}(n,this),a.remove()}));const o=e=>{a.contains(e.target)||(a.remove(),document.removeEventListener("click",o))};document.addEventListener("click",o),e.dataset.contextMenuInitialized="true"}))})),e.forEach((e=>{e.dataset.dragHandlersInitialized||(e.addEventListener("dragstart",(t=>{t.dataTransfer.setData("text/plain",e.dataset.noteId),t.dataTransfer.effectAllowed="move",e.classList.add("dragging")})),e.addEventListener("dragend",(()=>{e.classList.remove("dragging")})),e.dataset.dragHandlersInitialized="true")}));document.querySelectorAll(".board__column").forEach((e=>{if(!e.dataset.dropHandlersInitialized){const t=e.querySelector(".board__notes");t&&(t.addEventListener("dragover",(e=>{e.preventDefault();document.querySelector(".dragging")&&t.classList.add("drag-over")})),t.addEventListener("dragleave",(()=>{t.classList.remove("drag-over")})),t.addEventListener("drop",(async e=>{e.preventDefault(),t.classList.remove("drag-over");const n=e.dataTransfer.getData("text/plain"),a=document.querySelector(`.board__note[data-note-id="${n}"]`),s=e.target.closest(".board__column");if(a&&s){const e=s.classList.contains("board__column--todo")?"todo":s.classList.contains("board__column--doing")?"doing":"done";a.dataset.noteStatus=e,a.classList.remove("board__note--yellow","board__note--blue","board__note--green"),"todo"===a.dataset.noteStatus?a.classList.add("board__note--yellow"):"doing"===a.dataset.noteStatus?a.classList.add("board__note--blue"):"done"===a.dataset.noteStatus&&a.classList.add("board__note--green"),t.appendChild(a);try{const t=await fetch("functions/update_note.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({note_id:n,status:e})}),a=await t.json();a.success||(console.error("Ошибка при обновлении статуса заметки на сервере:",a.errors),alert("Ошибка при сохранении статуса заметки: "+(a.message||(a.errors?a.errors.join("\n"):"Неизвестная ошибка"))),o(document.querySelector(".board").dataset.boardId))}catch(e){console.error("Ошибка при отправке запроса на обновление статуса заметки:",e),alert("Ошибка соединения при сохранении статуса заметки."+(e.message?": "+e.message:"")),o(document.querySelector(".board").dataset.boardId)}}})))}e.dataset.dropHandlersInitialized="true"}))}()}(n.notes):(console.error("Ошибка при загрузке заметок:",n.errors),alert("Ошибка при загрузке заметок: "+n.errors.join("\n")))}catch(e){console.error("Ошибка при загрузке заметок:",e),alert("Ошибка при загрузке заметок"+(e.message?": "+e.message:""))}}async function s(e){const t=document.querySelector(".board"),n=t?t.dataset.boardId:null;if(!n)return alert("Ошибка: не найден board_id"),!1;try{const t=await fetch("functions/create_note.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:e,board_id:n})}),a=await t.json();if(a.success&&a.note_id){const e=document.querySelector(".board");return e&&e.dataset.boardId&&o(e.dataset.boardId),!0}return console.error("Ошибка при создании заметки:",a.errors||a.message),alert("Ошибка при создании заметки: "+(a.message||(a.errors?a.errors.join("\n"):"Неизвестная ошибка"))),!1}catch(e){return console.error("Ошибка соединения при создании заметки.",e),alert("Ошибка соединения при создании заметки."+(e.message?": "+e.message:"")),!1}}document.addEventListener("DOMContentLoaded",(()=>{!function(){const e=document.querySelector(".files__upload-btn"),t=document.querySelector(".files__input"),n=document.querySelector(".swiper-wrapper");if(!e||!t||!n)return;window.filesSwiper=new Swiper(".files-swiper",{slidesPerView:4,spaceBetween:20,centeredSlides:!1,pagination:{el:".swiper-pagination",clickable:!0},navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}});const o=document.createElement("div");o.className="swiper-empty-state",o.textContent="Загрузите файлы для их отображения",n.appendChild(o),function(){const e=n.querySelectorAll(".swiper-slide").length>0;o.style.display=e?"none":"flex"}(),e.addEventListener("click",(()=>{t.click()})),t.addEventListener("change",(async e=>{const n=Array.from(e.target.files);for(const e of n)await a(e);t.value=""}))}(),function(){const e=document.querySelectorAll(".board__note"),t=document.querySelectorAll(".board__column"),n=document.getElementById("createNoteModal"),a=document.querySelector(".board__add-btn");if(!n||!a||0===t.length)return;const r=document.querySelector(".modal__close-btn"),d=document.querySelector(".modal__cancel-btn"),c=document.querySelector(".modal__create-btn"),i=document.querySelector(".modal__textarea"),l=document.querySelector(".modal__title");if(!(r&&d&&c&&i&&l))return;const u=document.createElement("div");u.className="context-menu",u.innerHTML='\n\t\t<div class="context-menu__item" data-action="edit">Редактировать</div>\n\t\t<div class="context-menu__item" data-action="delete">Удалить</div>\n\t',document.body.appendChild(u);let m=null,p=!1;function h(e,t){e.preventDefault(),m=t,u.style.display="block";const n=u.getBoundingClientRect(),a=window.innerHeight,o=window.innerWidth;let s=e.clientY,r=e.clientX;s+n.height>a&&(s=a-n.height),r+n.width>o&&(r=o-n.width),u.style.top=`${s}px`,u.style.left=`${r}px`}function v(){u.style.display="none",m=null}function _(){n.classList.remove("active"),i.value="",p=!1,l.textContent="Создать новую задачу",c.textContent="Создать задачу",c.dataset.mode="create"}u.addEventListener("click",(e=>{const t=e.target.dataset.action;t&&m&&("edit"===t?function(e){const t=e.querySelector(".board__note-content")||e;i.value=t.textContent,n.classList.add("active"),i.focus(),p=!0,l.textContent="Редактировать задачу",c.textContent="Сохранить",c.dataset.mode="edit",c.dataset.noteId=e.dataset.noteId}(m):"delete"===t&&m.remove(),v())})),document.addEventListener("click",(e=>{u.contains(e.target)||v()})),a.addEventListener("click",(function(){n.classList.add("active"),i.focus(),p=!1,l.textContent="Создать новую задачу",c.textContent="Создать задачу",c.dataset.mode="create"})),r.addEventListener("click",_),d.addEventListener("click",_),c.addEventListener("click",(async function(){const e=c.dataset.mode,t=i.value.trim();if(t)if("create"===e){if(await s(t)){_();const e=document.querySelector(".board");e&&e.dataset.boardId&&o(e.dataset.boardId)}}else if("edit"===e){const e=c.dataset.noteId;if(!e)return;try{const n=await fetch("functions/update_note.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({note_id:e,content:t})}),a=await n.json();if(a.success){const n=document.querySelector(`.board__note[data-note-id="${e}"]`);n&&(n.querySelector(".board__note-content").textContent=t),_()}else console.error("Ошибка при сохранении заметки:",a.errors),alert("Ошибка при сохранении заметки: "+(a.message||(a.errors?a.errors.join("\n"):"Неизвестная ошибка")))}catch(e){console.error("Ошибка соединения при сохранении заметки.",e),alert("Ошибка соединения при сохранении заметки."+(e.message?": "+e.message:""))}}})),n.addEventListener("click",(e=>{e.target===n&&_()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&n.classList.contains("active")&&_()})),e.forEach((e=>{e.setAttribute("draggable","true"),e.addEventListener("dragstart",(t=>{const n=e.querySelector(".board__note-content")||e;t.dataTransfer.setData("text/plain",n.textContent),e.classList.add("dragging")})),e.addEventListener("dragend",(()=>{e.classList.remove("dragging")})),e.addEventListener("contextmenu",(t=>h(t,e)))})),t.forEach((e=>{e.addEventListener("dragover",(t=>{t.preventDefault(),document.querySelector(".dragging")&&e.querySelector(".board__notes").classList.add("drag-over")})),e.addEventListener("dragleave",(()=>{e.querySelector(".board__notes").classList.remove("drag-over")})),e.addEventListener("drop",(t=>{t.preventDefault();const n=document.querySelector(".dragging");if(n){const t=e.querySelector(".board__notes");t.classList.remove("drag-over"),n.classList.remove("board__note--yellow","board__note--blue","board__note--green"),e.classList.contains("board__column--todo")?n.classList.add("board__note--yellow"):e.classList.contains("board__column--doing")?n.classList.add("board__note--blue"):e.classList.contains("board__column--done")?n.classList.add("board__note--green"):n.classList.add("board__note--yellow"),t.appendChild(n)}}))}))}(),(document.getElementById("loginForm")||document.getElementById("registerForm"))&&e(),document.querySelector(".board__create-session-btn")&&new t;const r=document.querySelector(".profile__avatar-wrapper");if(r){const e=r.querySelector(".profile__avatar-edit"),t=document.getElementById("avatarInput"),n=r.querySelector(".profile__avatar-img");r.addEventListener("mouseenter",(()=>{e.style.display="block"})),r.addEventListener("mouseleave",(()=>{e.style.display="none"})),e.addEventListener("click",(()=>{t.click()})),t.addEventListener("change",(function(){if(t.files.length>0){const e=new FormData;e.append("avatar",t.files[0]),fetch("functions/profile_update.php",{method:"POST",body:e}).then((e=>e.json())).then((e=>{e.success&&e.avatar?n.src=e.avatar+"?t="+Date.now():e.errors&&(console.error("Ошибка при обновлении аватара:",e.errors),alert(e.errors.join("\n")))}))}}))}const d=document.getElementById("profileForm");d&&d.addEventListener("submit",(function(e){e.preventDefault();const t=new FormData(d);fetch("functions/profile_update.php",{method:"POST",body:t}).then((e=>e.json())).then((e=>{if(e.success){if(e.login&&(d.login.value=e.login),e.email&&(d.email.value=e.email),e.avatar){const t=document.querySelector(".profile__avatar-img");t&&(t.src=e.avatar+"?t="+Date.now())}alert("Профиль успешно обновлён!")}else e.errors&&(console.error("Ошибка при обновлении профиля:",e.errors),alert(e.errors.join("\n")))}))}));const c=document.querySelector(".board"),i=c?c.dataset.boardId:null;i&&(n(i),o(i));const l=document.getElementById("deleteSessionForm");l&&l.addEventListener("submit",(async function(e){if(e.preventDefault(),!confirm("Удалить сессию?"))return;const t=new FormData(l);try{const e=await fetch(window.location.pathname+window.location.search,{method:"POST",body:t});if(e.redirected)return void(window.location.href=e.url);await e.text();window.location.href="index.php"}catch(e){alert("Ошибка при удалении сессии")}}));const u=document.querySelector(".participants-list"),m=document.querySelector(".participants-more"),p=document.getElementById("participantsModal"),h=p?.querySelector(".modal__close-btn");u&&p&&u.addEventListener("click",(()=>{p.classList.add("active")})),m&&p&&m.addEventListener("click",(e=>{e.stopPropagation(),p.classList.add("active")})),h&&h.addEventListener("click",(()=>{p.classList.remove("active")})),p&&p.addEventListener("click",(e=>{e.target===p&&p.classList.remove("active")}))}))}();